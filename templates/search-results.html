                        <!-- Search Input Bar -->
                        <div x-show="searchVisible" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform -translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0" class="mb-6">
                            <div class="space-y-3">
                                <!-- Search Input -->
                                <div class="relative max-w-2xl mx-auto">
                                    <input
                                        id="searchInput"
                                        name="search"
                                        x-model="searchQuery"
                                        @input="performSearch()"
                                        @keydown.escape="toggleSearch()"
                                        @focus="if (searchQuery.trim()) performSearch()"
                                        type="text"
                                        placeholder="Search topics..."
                                        class="w-full px-4 py-3 pl-12 pr-12 text-lg text-slate-800 dark:text-slate-200 placeholder-slate-500 dark:placeholder-slate-400 bg-white dark:bg-gray-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/20 shadow-sm transition-all"
                                    />
                                    <i data-lucide="search" class="w-5 h-5 text-slate-400 dark:text-slate-500 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                                    <button x-show="searchQuery" @click="searchQuery = ''; performSearch(); $nextTick(() => document.getElementById('searchInput')?.focus())" class="absolute right-4 top-1/2 -translate-y-1/2 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                        <i data-lucide="x" class="w-4 h-4 text-slate-400 dark:text-slate-500"></i>
                                    </button>
                                </div>

                                <!-- Filter Buttons Row -->
                                <div class="flex items-center justify-center gap-2 flex-wrap">
                                    <!-- Clear All Filters Button -->
                                    <button @click="clearAllSearchFilters()" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80 whitespace-nowrap" title="Clear all filters">
                                        <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                                    </button>

                                    <!-- Vertical Divider -->
                                    <div class="h-8 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

                                    <button @click="selectAllSearchFilters()" :class="searchFilters.length === 4 ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80'" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                        <i data-lucide="layers" class="w-3.5 h-3.5 mr-1.5"></i>
                                        All
                                    </button>
                                    <button @click="toggleSearchFilter('audit')" :class="searchFilters.includes('audit') ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-300 dark:border-green-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80'" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                        <i data-lucide="clipboard-check" class="w-3.5 h-3.5 mr-1.5"></i>
                                        Knowledge Audit
                                    </button>
                                    <button @click="toggleSearchFilter('notes')" :class="searchFilters.includes('notes') ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80'" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                        <i data-lucide="sticky-note" class="w-3.5 h-3.5 mr-1.5"></i>
                                        Notes
                                    </button>
                                    <button @click="toggleSearchFilter('flashcards')" :class="searchFilters.includes('flashcards') ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 border-purple-300 dark:border-purple-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80'" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                        <i data-lucide="layers" class="w-3.5 h-3.5 mr-1.5"></i>
                                        Flashcards
                                    </button>
                                    <button @click="toggleSearchFilter('mindmaps')" :class="searchFilters.includes('mindmaps') ? 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 border-cyan-300 dark:border-cyan-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80'" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                        <i data-lucide="network" class="w-3.5 h-3.5 mr-1.5"></i>
                                        Mindmaps
                                    </button>

                                    <!-- Vertical Divider -->
                                    <div class="h-8 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

                                    <!-- Topic Filter Button -->
                                    <button @click="openTagSelector('search')" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80 whitespace-nowrap">
                                        <i data-lucide="plus" class="w-3.5 h-3.5 mr-1.5"></i>
                                        Topic filter
                                        <span x-show="selectedSearchTags.length > 0" class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 dark:bg-blue-500 rounded-full" x-text="selectedSearchTags.length"></span>
                                    </button>

                                    <!-- Confidence Level Filter Dropdown -->
                                    <div class="relative" @click.away="searchConfidenceDropdownOpen = false">
                                        <button @click="searchConfidenceDropdownOpen = !searchConfidenceDropdownOpen" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80 whitespace-nowrap">
                                            <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 mr-1.5"></i>
                                            Confidence level
                                            <span x-show="selectedConfidenceLevels.length > 0" class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 dark:bg-blue-500 rounded-full" x-text="selectedConfidenceLevels.length"></span>
                                            <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-1.5"></i>
                                        </button>

                                        <!-- Dropdown Menu -->
                                        <div x-show="searchConfidenceDropdownOpen"
                                             x-transition:enter="transition ease-out duration-100"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100"
                                             x-transition:leave="transition ease-in duration-75"
                                             x-transition:leave-start="opacity-100 scale-100"
                                             x-transition:leave-end="opacity-0 scale-95"
                                             class="absolute left-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden">

                                            <div class="p-3 space-y-2">
                                                <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Select confidence levels:</div>
                                                <template x-for="level in [1, 2, 3, 4, 5]" :key="level">
                                                    <label class="flex items-center space-x-2 py-2 px-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded cursor-pointer transition-colors">
                                                        <input type="checkbox"
                                                               :id="'confidence-level-' + level"
                                                               :name="'confidence-level-' + level"
                                                               :checked="selectedConfidenceLevels.includes(level)"
                                                               @change="toggleConfidenceLevel(level)"
                                                               class="w-4 h-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 dark:focus:ring-blue-400">
                                                        <div class="flex items-center space-x-2 flex-1">
                                                            <div class="flex items-center justify-center w-8 h-8 rounded text-sm font-bold text-white" :style="getConfidenceBarStyle(level)">
                                                                <span x-text="level"></span>
                                                            </div>
                                                            <span class="text-sm text-gray-900 dark:text-gray-100" x-text="getConfidenceLevelLabel(level)"></span>
                                                        </div>
                                                    </label>
                                                </template>
                                            </div>

                                            <div class="border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 p-2 flex justify-end">
                                                <button @click="clearConfidenceLevels(); searchConfidenceDropdownOpen = false" class="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 underline">Clear all</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sort By Dropdown -->
                                    <div class="relative" @click.away="searchSortDropdownOpen = false">
                                        <button @click="searchSortDropdownOpen = !searchSortDropdownOpen" class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600/80 whitespace-nowrap">
                                            <i data-lucide="arrow-up-down" class="w-3.5 h-3.5 mr-1.5"></i>
                                            Sort
                                            <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-1.5"></i>
                                        </button>

                                        <!-- Dropdown Menu -->
                                        <div x-show="searchSortDropdownOpen"
                                             x-transition:enter="transition ease-out duration-100"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100"
                                             x-transition:leave="transition ease-in duration-75"
                                             x-transition:leave-start="opacity-100 scale-100"
                                             x-transition:leave-end="opacity-0 scale-95"
                                             class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden">

                                            <div class="p-2">
                                                <button @click="setSearchSort('relevance'); searchSortDropdownOpen = false" :class="searchSortBy === 'relevance' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'" class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="target" class="w-4 h-4"></i>
                                                        Relevance
                                                    </div>
                                                    <i x-show="searchSortBy === 'relevance'" :data-lucide="searchSortDirection === 'desc' ? 'arrow-down' : 'arrow-up'" class="w-3.5 h-3.5"></i>
                                                </button>
                                                <button @click="setSearchSort('alphabetical'); searchSortDropdownOpen = false" :class="searchSortBy === 'alphabetical' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'" class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="type" class="w-4 h-4"></i>
                                                        Alphabetical
                                                    </div>
                                                    <i x-show="searchSortBy === 'alphabetical'" :data-lucide="searchSortDirection === 'desc' ? 'arrow-down' : 'arrow-up'" class="w-3.5 h-3.5"></i>
                                                </button>
                                                <button @click="setSearchSort('numerical'); searchSortDropdownOpen = false" :class="searchSortBy === 'numerical' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'" class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="hash" class="w-4 h-4"></i>
                                                        Numerical (Spec #)
                                                    </div>
                                                    <i x-show="searchSortBy === 'numerical'" :data-lucide="searchSortDirection === 'desc' ? 'arrow-down' : 'arrow-up'" class="w-3.5 h-3.5"></i>
                                                </button>
                                                <button @click="setSearchSort('confidence'); searchSortDropdownOpen = false" :class="searchSortBy === 'confidence' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'" class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                                        Confidence Level
                                                    </div>
                                                    <i x-show="searchSortBy === 'confidence'" :data-lucide="searchSortDirection === 'desc' ? 'arrow-down' : 'arrow-up'" class="w-3.5 h-3.5"></i>
                                                </button>
                                                <button @click="setSearchSort('date'); searchSortDropdownOpen = false" :class="searchSortBy === 'date' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'" class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                                        Date Created
                                                    </div>
                                                    <i x-show="searchSortBy === 'date'" :data-lucide="searchSortDirection === 'desc' ? 'arrow-down' : 'arrow-up'" class="w-3.5 h-3.5"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Selected Topic Filters Display -->
                                <div x-show="selectedSearchTags.length > 0" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" class="flex flex-wrap items-center gap-2">
                                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Topic filters:</span>
                                    <template x-for="tagId in selectedSearchTags" :key="tagId">
                                        <div class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs border border-blue-300 dark:border-blue-700">
                                            <span class="font-mono font-bold" x-text="tagId"></span>
                                            <span x-text="topicLookup[tagId] ? topicLookup[tagId].topicTitle : ''"></span>
                                            <button
                                                @click="removeSearchTopicFilter(tagId)"
                                                class="hover:bg-blue-200 dark:hover:bg-blue-800 rounded p-0.5 transition-colors">
                                                <i data-lucide="x" class="w-2.5 h-2.5"></i>
                                            </button>
                                        </div>
                                    </template>
                                    <button @click="clearSearchTags()" class="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 underline ml-1">Clear all</button>
                                </div>

                                <!-- Selected Confidence Levels Display -->
                                <div x-show="selectedConfidenceLevels.length > 0" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" class="flex flex-wrap items-center gap-2">
                                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Confidence levels:</span>
                                    <template x-for="level in [...selectedConfidenceLevels].sort((a, b) => a - b)" :key="level">
                                        <div class="flex items-center gap-1.5 px-2 py-1 rounded text-xs border border-gray-300 dark:border-gray-600">
                                            <div class="flex items-center justify-center w-6 h-6 rounded text-xs font-bold text-white" :style="getConfidenceBarStyle(level)">
                                                <span x-text="level"></span>
                                            </div>
                                            <span class="text-gray-700 dark:text-gray-300 font-medium" x-text="getConfidenceLevelLabel(level)"></span>
                                            <button
                                                @click="removeConfidenceLevel(level)"
                                                class="hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-0.5 transition-colors">
                                                <i data-lucide="x" class="w-2.5 h-2.5 text-gray-500 dark:text-gray-400"></i>
                                            </button>
                                        </div>
                                    </template>
                                    <button @click="clearConfidenceLevels()" class="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 underline ml-1">Clear all</button>
                                </div>
                            </div>
                        </div>

                        <div x-show="searchVisible && searchResults.length > 0" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95 -translate-y-4" x-transition:enter-end="opacity-100 transform scale-100 translate-y-0">
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200">Search Results</h2>
                                    <span class="text-sm text-gray-600 dark:text-gray-400" x-text="`${searchResults.length} result${searchResults.length !== 1 ? 's' : ''} found for '${searchQuery}'`"></span>
                                </div>
                                <div class="grid gap-4">
                                    <template x-for="result in searchResults" :key="result.id || result.topicId">
                                        <div @click="navigateToSearchResult(result)" :class="'bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border-l-4 cursor-pointer transition-all hover:shadow-md ' + result.borderClass">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1 mr-4">
                                                    <!-- Type badge and section info -->
                                                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                                                        <span :class="'inline-flex items-center text-xs font-semibold px-2 py-1 rounded ' + result.badgeClass">
                                                            <i :data-lucide="result.type === 'audit' ? 'clipboard-check' : result.type === 'note' ? 'sticky-note' : result.type === 'flashcard' ? 'layers' : 'network'" class="w-3 h-3 mr-1"></i>
                                                            <span x-text="result.type === 'audit' ? 'Audit Card' : result.type === 'note' ? 'Note' : result.type === 'flashcard' ? 'Flashcard Deck' : 'Mindmap'"></span>
                                                        </span>
                                                        <span x-show="result.topicId" class="text-xs font-semibold text-gray-600 dark:text-gray-400" x-text="result.topicId"></span>
                                                        <span x-show="result.paper" class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded" x-text="result.paper"></span>
                                                        <span x-show="result.cardCount !== undefined" class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded" x-text="`${result.cardCount} card${result.cardCount !== 1 ? 's' : ''}`"></span>
                                                        <span x-show="result.shapeCount !== undefined" class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded" x-text="`${result.shapeCount} shape${result.shapeCount !== 1 ? 's' : ''}`"></span>
                                                    </div>

                                                    <!-- Title -->
                                                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2" x-text="result.title || result.topicTitle"></h3>

                                                    <!-- Section -->
                                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" x-text="result.sectionTitle"></p>

                                                    <!-- Tags -->
                                                    <div x-show="result.tags && result.tags.length > 0" class="flex flex-wrap gap-1 mb-2">
                                                        <template x-for="tag in (result.tags || []).slice(0, 3)" :key="tag">
                                                            <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-0.5 rounded" x-text="tag"></span>
                                                        </template>
                                                        <span x-show="result.tags && result.tags.length > 3" class="text-xs text-gray-500 dark:text-gray-500" x-text="`+${(result.tags?.length || 3) - 3} more`"></span>
                                                    </div>

                                                    <!-- Snippet (pre-highlighted in search method - already sanitized) -->
                                                    <p class="text-sm text-gray-500 dark:text-gray-500" x-html="result.snippet"></p>
                                                </div>

                                                <!-- Confidence (only for audit cards) -->
                                                <div x-show="result.type === 'audit'" class="flex flex-col items-center">
                                                    <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Confidence</span>
                                                    <template x-if="result.confidence && result.confidence > 0">
                                                        <div class="flex items-center justify-center w-8 h-8 rounded text-sm font-bold text-white" :style="getConfidenceBarStyle(result.confidence)" x-text="result.confidence"></div>
                                                    </template>
                                                    <template x-if="!result.confidence || result.confidence === 0">
                                                        <div class="w-8 h-8 rounded border border-gray-300 dark:border-gray-600 flex items-center justify-center">
                                                            <span class="text-xs text-gray-400">-</span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div x-show="searchVisible && (searchQuery.trim() || selectedConfidenceLevels.length > 0) && searchResults.length === 0" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95 -translate-y-4" x-transition:enter-end="opacity-100 transform scale-100 translate-y-0">
                            <div class="text-center py-12">
                                <i data-lucide="search-x" class="w-16 h-16 text-gray-400 dark:text-gray-600 mx-auto mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No results found</h3>
                                <p class="text-gray-600 dark:text-gray-400">
                                    <template x-if="searchQuery.trim()">
                                        <span x-text="`No topics found matching '${searchQuery}'. Try a different search term.`"></span>
                                    </template>
                                    <template x-if="!searchQuery.trim() && selectedConfidenceLevels.length > 0">
                                        <span>No audit cards found with the selected confidence levels.</span>
                                    </template>
                                </p>
                            </div>
                        </div>

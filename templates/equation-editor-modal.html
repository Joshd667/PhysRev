<!-- NEW: Equation Editor Modal -->
<div x-show="showEquationEditor"
     x-data="{ mouseDownOnBackdrop: false }"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @mousedown.self="mouseDownOnBackdrop = true"
     @mouseup.self="if (mouseDownOnBackdrop) closeEquationEditor(); mouseDownOnBackdrop = false"
     @mouseleave="mouseDownOnBackdrop = false"
     class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">

    <!-- Modal Window -->
    <div x-show="showEquationEditor"
         x-data="{ activeTab: 'common' }"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center space-x-3">
                <i data-lucide="function-square" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Equation Editor</h2>
            </div>
            <button @click="closeEquationEditor()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4 minimal-scrollbar">
            <!-- Preview Area -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Preview</label>
                <div id="equation-preview" class="p-4 bg-gray-100 dark:bg-gray-900/50 rounded-lg min-h-[80px] flex items-center justify-center text-2xl overflow-x-auto [&_.katex]:!text-gray-900 dark:[&_.katex]:!text-gray-100"
                     x-html="renderEquationPreview(equationLatex)">
                </div>
            </div>

            <!-- Input Area with Help Text -->
            <div>
                <label for="latex-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Type Your Formula
                    <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Use buttons below or shortcuts: / for fractions, * for multiply, ^ for powers)</span>
                </label>
                <textarea id="latex-input"
                          x-model="equationLatex"
                          @input="handleEquationInput($event)"
                          class="w-full p-3 text-base text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-colors"
                          rows="2"
                          placeholder="e.g., E = mc^2 or F = ma"></textarea>
            </div>

            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <div class="flex gap-1">
                    <button @click="activeTab = 'common'"
                            :class="activeTab === 'common' ? 'border-b-2 border-purple-600 text-purple-600 dark:text-purple-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200'"
                            class="px-4 py-2 text-sm font-medium transition-colors">
                        Common
                    </button>
                    <button @click="activeTab = 'trig'"
                            :class="activeTab === 'trig' ? 'border-b-2 border-purple-600 text-purple-600 dark:text-purple-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200'"
                            class="px-4 py-2 text-sm font-medium transition-colors">
                        Trigonometry
                    </button>
                    <button @click="activeTab = 'logs'"
                            :class="activeTab === 'logs' ? 'border-b-2 border-purple-600 text-purple-600 dark:text-purple-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200'"
                            class="px-4 py-2 text-sm font-medium transition-colors">
                        Logs & Exp
                    </button>
                    <button @click="activeTab = 'greek'"
                            :class="activeTab === 'greek' ? 'border-b-2 border-purple-600 text-purple-600 dark:text-purple-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200'"
                            class="px-4 py-2 text-sm font-medium transition-colors">
                        Greek & Symbols
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="relative min-h-[200px]">
                <!-- Common Functions Tab -->
                <div x-show="activeTab === 'common'"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="absolute inset-0">
                    <div class="grid grid-cols-3 gap-2">
                        <button @click="insertSmartTemplate('fraction')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Fraction</div>
                            <div class="text-lg">a/b</div>
                        </button>
                        <button @click="insertSmartTemplate('multiply')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Multiply</div>
                            <div class="text-lg">×</div>
                        </button>
                        <button @click="insertSmartTemplate('power')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Power</div>
                            <div class="text-lg">x^n</div>
                        </button>
                        <button @click="insertSmartTemplate('squared')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Squared</div>
                            <div class="text-lg">x²</div>
                        </button>
                        <button @click="insertSmartTemplate('sqrt')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Square Root</div>
                            <div class="text-lg">√x</div>
                        </button>
                        <button @click="insertSmartTemplate('standardform')" class="p-3 bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-lg font-medium text-blue-900 dark:text-blue-100 transition-colors">
                            <div class="text-xs mb-1">Standard Form</div>
                            <div class="text-lg">×10^n</div>
                        </button>
                    </div>
                </div>

                <!-- Trigonometry Tab -->
                <div x-show="activeTab === 'trig'"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="absolute inset-0">
                    <div class="grid grid-cols-6 gap-2">
                        <button @click="insertSmartTemplate('sin')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">sin</button>
                        <button @click="insertSmartTemplate('cos')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">cos</button>
                        <button @click="insertSmartTemplate('tan')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">tan</button>
                        <button @click="insertSmartTemplate('arcsin')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">sin⁻¹</button>
                        <button @click="insertSmartTemplate('arccos')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">cos⁻¹</button>
                        <button @click="insertSmartTemplate('arctan')" class="p-2 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 rounded text-sm font-medium text-purple-900 dark:text-purple-100">tan⁻¹</button>
                    </div>
                </div>

                <!-- Logs & Exponentials Tab -->
                <div x-show="activeTab === 'logs'"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="absolute inset-0">
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="insertSmartTemplate('log')" class="p-2 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-sm font-medium text-green-900 dark:text-green-100">log</button>
                        <button @click="insertSmartTemplate('ln')" class="p-2 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-sm font-medium text-green-900 dark:text-green-100">ln</button>
                        <button @click="insertSmartTemplate('exp')" class="p-2 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-sm font-medium text-green-900 dark:text-green-100">e^x</button>
                        <button @click="insertSmartTemplate('e')" class="p-2 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-sm font-medium text-green-900 dark:text-green-100">e</button>
                    </div>
                </div>

                <!-- Greek Letters & Symbols Tab -->
                <div x-show="activeTab === 'greek'"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="absolute inset-0">
                    <div class="grid grid-cols-8 gap-2">
                        <button @click="insertLatexTemplate('\\alpha')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">α</button>
                        <button @click="insertLatexTemplate('\\beta')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">β</button>
                        <button @click="insertLatexTemplate('\\gamma')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">γ</button>
                        <button @click="insertLatexTemplate('\\theta')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">θ</button>
                        <button @click="insertLatexTemplate('\\lambda')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">λ</button>
                        <button @click="insertLatexTemplate('\\pi')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">π</button>
                        <button @click="insertLatexTemplate('\\rho')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">ρ</button>
                        <button @click="insertLatexTemplate('\\sigma')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">σ</button>
                        <button @click="insertLatexTemplate('\\omega')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">ω</button>
                        <button @click="insertLatexTemplate('\\Delta')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">Δ</button>
                        <button @click="insertLatexTemplate('\\Omega')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">Ω</button>
                        <button @click="insertLatexTemplate('\\mu')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">μ</button>
                        <button @click="insertLatexTemplate('\\phi')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">φ</button>
                        <button @click="insertLatexTemplate('\\epsilon')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">ε</button>
                        <button @click="insertSmartTemplate('subscript')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">x_n</button>
                        <button @click="insertSmartTemplate('vector')" class="p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm text-gray-900 dark:text-gray-100">→v</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="flex items-center justify-end gap-2 p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
            <button @click="closeEquationEditor()" class="px-3 py-1.5 text-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600 rounded transition-colors">
                Cancel
            </button>
            <button @click="insertEquation()" class="px-3 py-1.5 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors flex items-center gap-1.5">
                <i data-lucide="plus-square" class="w-3.5 h-3.5"></i>
                <span>Insert</span>
            </button>
        </div>
    </div>
</div>

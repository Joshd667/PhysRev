<div :class="sidebarVisible ? 'w-full md:w-80' : 'w-0'" class="transition-all duration-300 flex flex-col overflow-hidden md:relative absolute md:z-auto z-30 h-full bg-white dark:bg-gray-800 md:bg-transparent md:dark:bg-transparent">
    <div class="px-4 pt-4 pb-2 bg-white/30 dark:bg-gray-800/30 backdrop-blur-sm">
        <div class="flex items-center justify-between mb-4 pb-4 border-b border-white/20 dark:border-gray-600/30">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                    <template x-if="user && user.picture">
                        <img :src="user.picture" :alt="user.name" class="w-8 h-8 rounded-full">
                    </template>
                    <template x-if="!user || !user.picture">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </template>
                </div>
                <div>
                    <div class="text-sm font-medium text-slate-800 dark:text-slate-200" x-text="user ? user.name : 'Guest'"></div>
                    <div class="text-xs text-slate-600 dark:text-slate-400" x-text="authMethod === 'teams' ? 'Microsoft Teams' : 'Local Storage'"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Online/Offline Status Indicator -->
                <div class="relative"
                     x-data="{ showSyncTooltip: false }"
                     @mouseenter="showSyncTooltip = true"
                     @mouseleave="showSyncTooltip = false">
                    <button class="p-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors relative" title="Network Status">
                        <div class="w-5 h-5 flex items-center justify-center">
                            <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'"
                                 class="w-2.5 h-2.5 rounded-full"></div>
                            <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'"
                                 x-show="isOnline"
                                 class="w-2.5 h-2.5 rounded-full absolute animate-ping"></div>
                        </div>
                    </button>

                    <!-- Sync Tooltip -->
                    <div x-show="showSyncTooltip"
                         x-cloak
                         class="absolute top-full right-0 mt-2 w-48 p-2 bg-gray-900 dark:bg-gray-800 text-white text-xs rounded-lg shadow-lg z-50">
                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Status:</span>
                                <span class="font-semibold" x-text="isOnline ? 'Connected' : 'Offline'"></span>
                            </div>
                            <div x-show="lastSyncTime" class="flex justify-between">
                                <span>Last sync:</span>
                                <span class="font-semibold" x-text="getTimeSinceSync()"></span>
                            </div>
                            <div x-show="authMethod === 'teams' && isOnline" class="pt-1 border-t border-gray-700">
                                <button @click="syncDataNow()"
                                        class="w-full px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-xs font-medium transition-colors">
                                    Sync Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openSettings()" class="p-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors relative" title="Settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <!-- Update badge -->
                    <span x-show="updateAvailable"
                          class="absolute -top-1 -right-1 flex h-4 w-4">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-white text-xs items-center justify-center font-bold">!</span>
                    </span>
                </button>
                <button @click="toggleDarkMode()" class="p-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors" title="Toggle dark mode">
                    <i :data-lucide="darkMode ? 'sun' : 'moon'" class="w-5 h-5"></i>
                </button>
                <button @click.stop="sidebarVisible = false; searchVisible = false; $nextTick(() => lucide.createIcons());" class="p-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors md:hidden" title="Close sidebar">
                    <svg class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- View Selector Dropdown -->
        <div class="relative mb-4">
            <button @click="toggleViewSelector()" class="flex items-center justify-between w-full px-3 py-2 bg-white/60 dark:bg-gray-700/60 hover:bg-white/80 dark:hover:bg-gray-600/80 backdrop-blur-sm rounded-lg transition-colors">
                <div class="flex items-center space-x-2">
                    <i :data-lucide="getViewIcon()" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                    <span class="text-sm font-bold text-slate-800 dark:text-slate-200" x-text="getViewTitle()"></span>
                </div>
                <svg class="w-4 h-4 transition-transform duration-200 text-gray-600 dark:text-gray-400" :class="showViewSelector ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>

            <!-- Dropdown Menu -->
            <div x-show="showViewSelector"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 @click.away="closeViewSelector()"
                 class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50 overflow-hidden">
                <button @click="switchViewType('audit')" :class="viewType === 'audit' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'" class="w-full flex items-center space-x-2 px-3 py-2 transition-colors">
                    <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Knowledge Audit</span>
                </button>
                <button @click="switchViewType('notes')" :class="viewType === 'notes' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'" class="w-full flex items-center space-x-2 px-3 py-2 transition-colors border-t border-gray-100 dark:border-gray-600">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Notes</span>
                </button>
                <button @click="switchViewType('flashcards')" :class="viewType === 'flashcards' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'" class="w-full flex items-center space-x-2 px-3 py-2 transition-colors border-t border-gray-100 dark:border-gray-600">
                    <i data-lucide="layers" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Flashcards</span>
                </button>
                <button @click="switchViewType('mindmaps')" :class="viewType === 'mindmaps' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'" class="w-full flex items-center space-x-2 px-3 py-2 transition-colors border-t border-gray-100 dark:border-gray-600">
                    <i data-lucide="network" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Mindmaps</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-4">
            <!-- Paper 1 Button -->
            <button @click="setSelectedPaper('Paper 1'); searchVisible = false; $nextTick(() => lucide.createIcons());"
                    :class="viewMode === 'paper' && selectedPaper === 'Paper 1' ? 'bg-blue-600 text-white shadow' : 'bg-white/60 dark:bg-gray-700/60 text-slate-700 dark:text-slate-300 hover:bg-white/80 dark:hover:bg-gray-600/80'"
                    class="w-full px-2 py-2 rounded text-sm font-medium transition-colors flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <text x="50%" y="62%" dominant-baseline="middle" text-anchor="middle" fill="currentColor" font-size="10">1</text>
                </svg>
                <span class="text-xs">Paper 1</span>
            </button>

            <!-- Paper 2 Button -->
            <button @click="setSelectedPaper('Paper 2'); searchVisible = false; $nextTick(() => lucide.createIcons());"
                    :class="viewMode === 'paper' && selectedPaper === 'Paper 2' ? 'bg-blue-600 text-white shadow' : 'bg-white/60 dark:bg-gray-700/60 text-slate-700 dark:text-slate-300 hover:bg-white/80 dark:hover:bg-gray-600/80'"
                    class="w-full px-2 py-2 rounded text-sm font-medium transition-colors flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <text x="50%" y="62%" dominant-baseline="middle" text-anchor="middle" fill="currentColor" font-size="10">2</text>
                </svg>
                <span class="text-xs">Paper 2</span>
            </button>

            <!-- Paper 3 Button -->
            <button @click="setSelectedPaper('Paper 3'); searchVisible = false; $nextTick(() => lucide.createIcons());"
                    :class="viewMode === 'paper' && selectedPaper === 'Paper 3' ? 'bg-blue-600 text-white shadow' : 'bg-white/60 dark:bg-gray-700/60 text-slate-700 dark:text-slate-300 hover:bg-white/80 dark:hover:bg-gray-600/80'"
                    class="w-full px-2 py-2 rounded text-sm font-medium transition-colors flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <text x="50%" y="62%" dominant-baseline="middle" text-anchor="middle" fill="currentColor" font-size="10">3</text>
                </svg>
                <span class="text-xs">Paper 3</span>
            </button>

            <!-- Spec Mode Button -->
            <button @click.stop="toggleViewMode(); searchVisible = false; $nextTick(() => lucide.createIcons());"
                    :class="viewMode === 'spec' ? 'bg-green-600 text-white shadow' : 'bg-white/60 dark:bg-gray-700/60 text-slate-700 dark:text-slate-300 hover:bg-white/80 dark:hover:bg-gray-600/80'"
                    class="w-full px-2 py-2 rounded text-sm font-medium transition-colors flex flex-col items-center justify-center gap-1"
                    :title="viewMode === 'paper' ? 'Switch to Spec Mode' : 'Switch to Paper Mode'">
                <i data-lucide="files" class="w-5 h-5"></i>
                <span class="text-xs">Spec</span>
            </button>
        </div>

        <div class="mb-2">
            <h5 class="font-bold text-xs text-gray-700 dark:text-gray-300 mb-2" x-text="progressTitle"></h5>
            <div class="grid grid-cols-2 gap-2 text-sm" x-data="{ get _progress() { return getOverallProgress(); }, get _confidence() { return getAverageConfidence(); } }">
                <div class="bg-white/60 dark:bg-gray-700/60 backdrop-blur-sm p-2 rounded">
                    <div class="text-blue-700 dark:text-blue-400 font-medium">Progress</div>
                    <div class="text-blue-800 dark:text-blue-300 font-bold"><span x-text="_progress"></span>%</div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" :style="'width: ' + _progress + '%'"></div>
                    </div>
                </div>
                <div class="bg-white/60 dark:bg-gray-700/60 backdrop-blur-sm p-2 rounded">
                    <div class="text-green-700 dark:text-green-400 font-medium">Confidence</div>
                    <div class="text-green-800 dark:text-green-300 font-bold"><span x-text="_confidence.toFixed(1)"></span>/5</div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                        <div class="h-2 rounded-full transition-all duration-300" :style="'width: ' + ((_confidence / 5) * 100) + '%' + '; ' + getConfidenceBarStyle(Math.round(_confidence))"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="h-px bg-white/30 dark:bg-gray-600/30 backdrop-blur-sm"></div>
    <div class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 minimal-scrollbar">
        <template x-for="item in currentGroups" :key="item.title || item.key">
            <div>
                <template x-if="item.type === 'single'">
                    <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-600">
                        <button @click="selectSection(item.key); searchVisible = false;" :class="((viewType === 'notes' || viewType === 'flashcards' || viewType === 'mindmaps') && contentFilterSection === item.key) || (viewType === 'audit' && activeSection === item.key) ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700' : 'bg-gray-100 dark:bg-gray-700/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'" class="w-full px-3 py-2 rounded-lg border transition-colors duration-300 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i :data-lucide="specificationData[item.key].icon" :class="(((viewType === 'notes' || viewType === 'flashcards' || viewType === 'mindmaps') && contentFilterSection === item.key) || (viewType === 'audit' && activeSection === item.key)) ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400'" class="w-4 h-4 flex-shrink-0"></i>
                                <div class="text-left flex-1">
                                    <div class="text-sm font-bold" x-text="specificationData[item.key].title"></div>
                                    <div class="text-xs opacity-75 mt-0.5"><span x-text="getAssessedCount(specificationData[item.key].topics)"></span>/<span x-text="specificationData[item.key].topics.length"></span> assessed</div>
                                </div>
                            </div>
                            <svg class="w-4 h-4 transition-transform duration-300 flex-shrink-0" :class="(((viewType === 'notes' || viewType === 'flashcards' || viewType === 'mindmaps') && contentFilterSection === item.key) || (viewType === 'audit' && activeSection === item.key)) ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </template>
                <template x-if="item.type === 'group'">
                    <div>
                        <button @click="toggleGroup(item.title); searchVisible = false; $nextTick(() => lucide.createIcons());" :class="expandedGroups[item.title] ? 'bg-green-100 dark:bg-green-900/50 border-l-4 border-l-green-500 dark:border-l-green-500' : 'bg-gray-100 dark:bg-gray-700 border-l-4 border-l-transparent'" class="w-full p-3 text-left border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i :data-lucide="item.icon" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                                    <div>
                                        <div class="text-sm font-bold text-gray-900 dark:text-gray-100" x-text="item.title"></div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1"><span x-text="getGroupAssessedCount(item.sections)"></span>/<span x-text="getGroupTotalTopics(item.sections)"></span> assessed</div>
                                    </div>
                                </div>
                                <svg :class="expandedGroups[item.title] ? 'rotate-90' : ''" class="w-4 h-4 text-gray-400 dark:text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </button>
                        <div class="dropdown-content" :class="expandedGroups[item.title] ? 'expanded' : ''">
                            <div class="bg-gray-50 dark:bg-gray-700 px-3 py-2 space-y-2">
                                <template x-for="sectionKey in item.sections" :key="sectionKey">
                                    <button @click="selectSection(sectionKey); searchVisible = false;" :class="(((viewType === 'notes' || viewType === 'flashcards' || viewType === 'mindmaps') && contentFilterSection === sectionKey) || (viewType === 'audit' && activeSection === sectionKey)) ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700' : 'bg-white dark:bg-gray-600/60 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-500 hover:bg-gray-100 dark:hover:bg-gray-500'" class="w-full px-3 py-2 rounded-lg border transition-colors duration-300 flex items-center justify-between">
                                        <div class="text-left flex-1">
                                            <div class="text-sm font-medium" x-text="specificationData[sectionKey].title"></div>
                                            <div class="text-xs opacity-75 mt-0.5"><span x-text="getAssessedCount(specificationData[sectionKey].topics)"></span>/<span x-text="specificationData[sectionKey].topics.length"></span> assessed</div>
                                        </div>
                                        <svg class="w-3 h-3 transition-transform duration-300 flex-shrink-0 ml-2" :class="(((viewType === 'notes' || viewType === 'flashcards' || viewType === 'mindmaps') && contentFilterSection === sectionKey) || (viewType === 'audit' && activeSection === sectionKey)) ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>
    <div class="p-2 border-t border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
        <button @click="showAnalytics()" class="w-full flex items-center justify-center space-x-2 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-3 py-2.5 rounded-lg transition-colors shadow-lg font-medium">
            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
            <span>Analytics Dashboard</span>
        </button>
    </div>
</div>

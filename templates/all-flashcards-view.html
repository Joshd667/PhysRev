<!-- All Flashcards View -->
<div x-show="viewType === 'flashcards' && !showingRevision && !showingAnalytics && !searchVisible" class="relative">
    <!-- Main Choice: View All Flashcards or Test Area -->
    <div x-show="!showTestArea && studyMaterialsFilter === 'all'" class="space-y-6">
        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200 mb-6">Flashcard Options</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- View All Flashcards Card -->
            <button @click="studyMaterialsFilter = 'decks'" class="group bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border-2 border-purple-200 dark:border-purple-700 rounded-xl p-8 hover:shadow-lg transition-all hover:scale-105">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-20 h-20 bg-purple-600 dark:bg-purple-500 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="layers" class="w-10 h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">View All Flashcards</h3>
                    <p class="text-slate-600 dark:text-slate-400">Browse and manage all your flashcard decks</p>
                </div>
            </button>

            <!-- Test Area Card -->
            <button @click="openTestArea()" class="group bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-2 border-green-200 dark:border-green-700 rounded-xl p-8 hover:shadow-lg transition-all hover:scale-105">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-20 h-20 bg-green-600 dark:bg-green-500 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="clipboard-check" class="w-10 h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Test Area</h3>
                    <p class="text-slate-600 dark:text-slate-400">Create custom test sets from your decks</p>
                </div>
            </button>

            <!-- Quick Play Card -->
            <button @click="startQuickPlayTest()" class="group bg-gradient-to-br from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 border-2 border-orange-200 dark:border-orange-700 rounded-xl p-8 hover:shadow-lg transition-all hover:scale-105">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-20 h-20 bg-orange-600 dark:bg-orange-500 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="zap" class="w-10 h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Quick Play</h3>
                    <p class="text-slate-600 dark:text-slate-400">Test 10 random cards instantly</p>
                </div>
            </button>
        </div>
    </div>

    <!-- Floating Add Deck Button (shown in decks view mode only) -->
    <button x-show="!showTestArea && studyMaterialsFilter === 'decks'" @click="openFlashcardEditor()" class="fixed bottom-6 right-6 w-14 h-14 bg-purple-600/80 hover:bg-purple-700/90 backdrop-blur-sm text-white rounded-full shadow-lg hover:shadow-xl transition-all z-50 flex items-center justify-center" title="New Deck">
        <i data-lucide="plus" class="w-6 h-6"></i>
    </button>

    <!-- View All Flashcards Mode -->
    <div x-show="!showTestArea && studyMaterialsFilter === 'decks'">
        <!-- Header with Back Button and View Toggle -->
        <div class="mb-6 flex items-center justify-between">
            <button @click="studyMaterialsFilter = 'all'" class="flex items-center space-x-2 px-4 py-2 bg-white/60 dark:bg-gray-700/60 hover:bg-white/80 dark:hover:bg-gray-600/80 backdrop-blur-sm rounded-lg transition-colors text-gray-700 dark:text-gray-300">
                <svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="text-sm font-medium">Back to Flashcard Options</span>
            </button>
            
            <!-- View Toggle and Filters -->
            <div class="flex items-center gap-2">
                <div x-show="flashcardViewMode === 'card' && flashcardsGroupedBySection.length > 0" class="relative" x-data="{ open: false }" x-init="$nextTick(() => { if (window.lucide) lucide.createIcons(); }); $watch('open', value => { if (value && window.lucide) { lucide.createIcons(); } })" @keydown.escape.window="open = false">
                    <button @click="open = !open" class="p-2 bg-white/60 dark:bg-gray-700/60 backdrop-blur-sm rounded-md border border-gray-200 dark:border-gray-600 hover:bg-white/80 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300" :class="open ? 'ring-2 ring-purple-400/60' : ''" title="Sort decks">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                    </button>
                    <div x-cloak x-show="open" x-transition.origin-top-right class="absolute top-0 right-full mr-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg py-3 px-3 w-48" @click.outside="open = false" @click.stop>
                        <span class="block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">Sort decks by</span>
                        <div class="space-y-2">
                            <button @click="flashcardCardSort = 'updated'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="flashcardCardSort === 'updated' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>Date</span>
                            </button>
                            <button @click="flashcardCardSort = 'cards'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="flashcardCardSort === 'cards' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                <i data-lucide="layers" class="w-4 h-4"></i>
                                <span>Cards</span>
                            </button>
                            <button @click="flashcardCardSort = 'tries'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="flashcardCardSort === 'tries' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                <i data-lucide="bar-chart" class="w-4 h-4"></i>
                                <span>Tries</span>
                            </button>
                            <button @click="flashcardCardSort = 'percentage'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="flashcardCardSort === 'percentage' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>%</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center bg-white/60 dark:bg-gray-700/60 backdrop-blur-sm rounded-lg p-1">
                    <button @click="flashcardViewMode = 'list'" :class="flashcardViewMode === 'list' ? 'bg-purple-600 text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'" class="px-3 py-1.5 rounded-md transition-colors flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i>
                        <span class="text-sm font-medium">List</span>
                    </button>
                    <button @click="flashcardViewMode = 'card'" :class="flashcardViewMode === 'card' ? 'bg-purple-600 text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'" class="px-3 py-1.5 rounded-md transition-colors flex items-center gap-2">
                        <i data-lucide="grid" class="w-4 h-4"></i>
                        <span class="text-sm font-medium">Card</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <template x-if="flashcardsGroupedBySection.length === 0">
            <div class="text-center py-16">
                <i data-lucide="layers" class="w-16 h-16 text-gray-400 dark:text-gray-600 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No flashcard decks found</h3>
                <p class="text-gray-500 dark:text-gray-400">No flashcard decks for this selection</p>
            </div>
        </template>

        <!-- Flashcard Decks List Grouped by Group and Section -->
        <div class="space-y-6 -mt-6" x-show="flashcardsGroupedBySection.length > 0 && flashcardViewMode === 'list'" x-effect="if (flashcardViewMode === 'list' && window.lucide) { $nextTick(() => lucide.createIcons()); }">
        <template x-for="group in flashcardsGroupedBySection" :key="group.groupTitle">
            <div x-data="{ groupExpanded: true }" x-effect="if (groupExpanded && window.lucide) { $nextTick(() => lucide.createIcons()); }">
                <!-- Group Header -->
                <button @click="groupExpanded = !groupExpanded" class="w-full flex items-center justify-between mb-4 pb-3 border-b-4 border-purple-600 dark:border-purple-500 hover:opacity-80 transition-opacity">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 transition-transform duration-200" :class="groupExpanded ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <i :data-lucide="group.groupIcon" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200" x-text="group.groupTitle"></h2>
                    </div>
                    <span class="text-sm text-slate-500 dark:text-slate-400" x-data="{ count: group.sections.reduce((sum, s) => sum + s.decks.length, 0) }" x-text="`${count} ${count === 1 ? 'deck' : 'decks'}`"></span>
                </button>

                <!-- Sections within this group -->
                <div x-show="groupExpanded" class="ml-6 space-y-6">
                    <template x-for="section in group.sections" :key="section.sectionName">
                        <div x-data="{ sectionExpanded: true }">
                            <!-- Section Header -->
                            <button @click="sectionExpanded = !sectionExpanded" class="w-full flex items-center justify-between mb-3 pb-2 border-b-2 border-purple-400 dark:border-purple-300 hover:opacity-80 transition-opacity">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400 transition-transform duration-200" :class="sectionExpanded ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200" x-text="section.sectionTitle"></h3>
                                    <span x-show="section.sectionPaper" class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded" x-text="section.sectionPaper"></span>
                                </div>
                                <span class="text-sm text-slate-500 dark:text-slate-400" x-text="`${section.decks.length} ${section.decks.length === 1 ? 'deck' : 'decks'}`"></span>
                            </button>

                            <!-- Flashcard Decks in this section -->
                            <div x-show="sectionExpanded" class="space-y-3">
                                <template x-for="deck in section.decks" :key="deck.id">
                                    <div :data-deck-id="deck.id" x-data="{ deckExpanded: false }" class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow">
                                        <!-- Deck Header (always visible) -->
                                        <div class="p-4 flex items-start justify-between">
                                            <div @click="deckExpanded = !deckExpanded" class="flex items-start space-x-2 flex-1 cursor-pointer">
                                                <svg class="w-4 h-4 text-purple-600 dark:text-purple-400 transition-transform duration-200 mt-0.5 flex-shrink-0" :class="deckExpanded ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <div class="flex-1 min-w-0">
                                                    <h3 class="font-bold text-base text-slate-800 dark:text-slate-200 mb-1" x-text="deck.name"></h3>
                                                    <div class="flex items-center space-x-3 text-xs text-slate-500 dark:text-slate-400">
                                                        <span x-text="formatDate(deck.updatedAt)"></span>
                                                        <span class="flex items-center space-x-1">
                                                            <i data-lucide="layers" class="w-3 h-3"></i>
                                                            <span x-text="`${deck.cards.length} ${deck.cards.length === 1 ? 'card' : 'cards'}`"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-1 ml-2 flex-shrink-0">
                                                <button @click="testSingleDeck(deck.id)" class="p-1.5 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded transition-colors" title="Test deck">
                                                    <i data-lucide="play" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                                                </button>
                                                <button @click="editFlashcardDeck(deck.id)" class="p-1.5 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded transition-colors" title="Edit deck">
                                                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                    </svg>
                                                </button>
                                                <button @click="toggleDeckPin(deck.id)" class="p-1.5 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded transition-colors" :title="deck.pinned ? 'Unpin deck' : 'Pin deck'">
                                                    <i :data-lucide="deck.pinned ? 'pin' : 'pin-off'" class="w-4 h-4 text-yellow-500 dark:text-yellow-400"></i>
                                                </button>
                                                <button @click="deleteFlashcardDeck(deck.id)" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors" title="Delete deck">
                                                    <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Deck Details (collapsible) -->
                                        <div x-show="deckExpanded" class="px-4 pb-4">
                                            <!-- Flashcards in deck -->
                                            <div class="space-y-2 mb-3">
                                                <template x-if="!deck.cards || deck.cards.length === 0">
                                                    <p class="text-sm text-gray-500 dark:text-gray-400 italic">No cards in this deck</p>
                                                </template>
                                                <!-- STABILITY: Use hash of card content for stable unique keys -->
                                                <!-- WHY: Cards don't have IDs. Using index causes instability on reorder.
                                                          Using substring(0,30) causes collisions if multiple cards
                                                          start with the same text. Hash function ensures uniqueness. -->
                                                <template x-for="(card, index) in deck.cards" :key="window.generateCardKey(deck.id, card, index)">
                                                    <div class="grid grid-cols-2 gap-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                                        <!-- Front Column -->
                                                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800">
                                                            <div class="user-note-content text-sm text-gray-800 dark:text-gray-200" x-html="sanitizeHTML(card.front)"></div>
                                                        </div>
                                                        <!-- Back Column -->
                                                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800">
                                                            <div class="user-note-content text-sm text-gray-800 dark:text-gray-200" x-html="sanitizeHTML(card.back)"></div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Tags -->
                                            <div class="flex flex-wrap gap-1.5 pt-2 border-t border-gray-200 dark:border-gray-700">
                                                <template x-if="!deck.tags || deck.tags.length === 0">
                                                    <span class="text-xs text-slate-400 dark:text-slate-500 italic">No tags</span>
                                                </template>
                                                <template x-for="tagId in (deck.tags || [])" :key="tagId">
                                                    <span class="inline-flex items-center px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-medium">
                                                        <span class="font-mono font-bold mr-1" x-text="tagId"></span>
                                                        <span x-text="topicLookup[tagId] ? topicLookup[tagId].topicTitle : ''"></span>
                                                    </span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        </div>

        <!-- Card View Mode -->
        <!-- PERFORMANCE: Flatten and paginate flashcard decks with caching -->
        <!-- WHY: Decks with multiple tags appear in multiple sections, causing duplicate
                  IDs in x-for loops. We deduplicate using the shared utility with caching
                  to avoid recalculation on every render. -->
        <div x-show="flashcardsGroupedBySection.length > 0 && flashcardViewMode === 'card'"
             x-data="{
                 _cachedDecks: null,
                 _decksCacheKey: null,

                 get allDecks() {
                     // PERFORMANCE: O(1) for cache hits, O(n) for cache misses
                     // Generate lightweight cache key based on group structure
                     const currentKey = JSON.stringify(
                         (flashcardsGroupedBySection || []).map(g => g.groupTitle + ':' + (g.sections || []).length)
                     );

                     // Return cached result if structure hasn't changed
                     if (this._decksCacheKey === currentKey && this._cachedDecks) {
                         return this._cachedDecks;
                     }

                     // Recalculate using shared utility (handles null checks and deduplication)
                     this._cachedDecks = window.flattenAndDeduplicate(flashcardsGroupedBySection, 'decks');
                     this._decksCacheKey = currentKey;

                     return this._cachedDecks;
                 },
                 deckPagination: null
             }"
             x-init="deckPagination = $paginated(allDecks, 30, 15); $watch('allDecks', (value) => deckPagination.updateItems(value))">

            <!-- Deck count info -->
            <div x-show="deckPagination && deckPagination.totalCount > 30" class="mb-4 text-sm text-gray-600 dark:text-gray-400 text-center">
                Showing <span x-text="deckPagination.visibleItems.length"></span> of <span x-text="deckPagination.totalCount"></span> decks
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                 role="list"
                 aria-label="Flashcard decks in card view"
                 x-init="$nextTick(() => { if (window.lucide) lucide.createIcons(); })"
                 x-effect="if (flashcardViewMode === 'card' && window.lucide) { $nextTick(() => lucide.createIcons()); }">
                <template x-for="deck in (deckPagination ? deckPagination.visibleItems : allDecks)" :key="deck.id">
                        <div role="article"
                             :aria-label="`Flashcard deck: ${deck.name}`"
                             class="bg-white dark:bg-gray-800 rounded-lg shadow-md border-2 hover:shadow-lg transition-all flex flex-col h-full"
                             :class="deck.pinned ? 'border-yellow-400 dark:border-yellow-500' : 'border-gray-200 dark:border-gray-700'">
                            <div class="p-6 flex-1 flex flex-col">
                                <!-- Header with Actions -->
                                <div class="flex items-start justify-between mb-3 gap-2">
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 flex-1 truncate" x-text="deck.name" :title="deck.name"></h3>
                                    <div class="flex items-center gap-1 flex-shrink-0">
                                        <button @click="editFlashcardDeck(deck.id)" class="p-1.5 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded transition-colors" title="Edit">
                                            <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button @click="toggleDeckPin(deck.id)" class="p-1.5 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded transition-colors" :title="deck.pinned ? 'Unpin' : 'Pin'">
                                            <i :data-lucide="deck.pinned ? 'pin' : 'pin-off'" class="w-4 h-4 text-yellow-500 dark:text-yellow-400"></i>
                                        </button>
                                        <button @click="deleteFlashcardDeck(deck.id)" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors" title="Delete">
                                            <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Stats - Cards, Tests, and Score -->
                                <div class="flex items-center flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600 dark:text-gray-400 mb-3">
                                    <span class="flex items-center space-x-1">
                                        <i data-lucide="layers" class="w-4 h-4"></i>
                                        <span x-text="`${deck.cards.length} ${deck.cards.length === 1 ? 'card' : 'cards'}`"></span>
                                    </span>
                                    <span x-show="deckHasResults(deck)" class="flex items-center space-x-1">
                                        <i data-lucide="bar-chart" class="w-4 h-4"></i>
                                        <span x-text="getDeckResultsCount(deck) + ' ' + (getDeckResultsCount(deck) === 1 ? 'test' : 'tests')"></span>
                                    </span>
                                    <span x-show="deckHasResults(deck)" class="flex items-center space-x-1" :class="getDeckPercentageClass(deck)">
                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                        <span x-text="deckShowsPercentage(deck) ? (getDeckLastPercent(deck) + '%') : 'N/A'"></span>
                                    </span>
                                </div>

                                <!-- Tags -->
                                <div class="mb-3 min-h-[2.5rem]">
                                    <div class="flex flex-wrap gap-1.5">
                                        <template x-if="!deck.tags || deck.tags.length === 0">
                                            <span class="text-xs text-slate-400 dark:text-slate-500 italic">No tags</span>
                                        </template>
                                        <template x-for="tagId in (deck.tags || []).slice(0, 3)" :key="tagId">
                                            <span class="inline-flex items-center px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-medium">
                                                <span class="font-mono font-bold mr-1" x-text="tagId"></span>
                                                <span class="truncate max-w-[100px]" x-text="topicLookup[tagId] ? topicLookup[tagId].topicTitle : ''"></span>
                                            </span>
                                        </template>
                                        <span x-show="deck.tags && deck.tags.length > 3" class="inline-flex items-center px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded text-xs">
                                            <span x-text="`+${deck.tags.length - 3}`"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- Spacer to push bottom content down -->
                                <div class="flex-1"></div>

                                <!-- Date on the line -->
                                <div class="flex items-center space-x-1 text-xs text-slate-500 dark:text-slate-400 pt-3 border-t border-gray-200 dark:border-gray-700">
                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                    <span x-text="formatDate(deck.createdAt || deck.updatedAt)"></span>
                                </div>

                                <!-- Play Deck Button at Bottom -->
                                <div class="mt-auto pb-1 pt-3 border-t border-gray-200 dark:border-gray-700">
                                    <button @click="testSingleDeck(deck.id)" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition-colors">
                                        <i data-lucide="play" class="w-4 h-4"></i>
                                        <span>Play Deck</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                </template>
            </div>

            <!-- âœ… PAGINATION: Load More Button for Flashcard Decks -->
            <div x-show="deckPagination && deckPagination.hasMore" class="flex flex-col items-center gap-3 py-6 mt-4">
                <!-- Progress bar -->
                <div class="w-full max-w-md">
                    <div class="flex justify-between text-xs text-slate-600 dark:text-slate-400 mb-1">
                        <span>Showing <span x-text="deckPagination.visibleItems.length"></span> of <span x-text="deckPagination.totalCount"></span> decks</span>
                        <span x-text="deckPagination.percentageLoaded + '%'"></span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300 ease-out" :style="`width: ${deckPagination.percentageLoaded}%`"></div>
                    </div>
                </div>

                <!-- Load More Button -->
                <button @click="deckPagination.loadMore()" aria-label="Load more flashcard decks" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                    <i data-lucide="arrow-down-circle" class="w-5 h-5" aria-hidden="true"></i>
                    <span>Load More (<span x-text="deckPagination.remainingCount"></span> decks)</span>
                </button>

                <!-- Show All Button -->
                <button x-show="deckPagination.remainingCount < 30" @click="deckPagination.showAll()" aria-label="Show all flashcard decks" class="px-4 py-2 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 font-medium underline">
                    Show All Decks
                </button>
            </div>
        </div>
    </div>
    <!-- End View All Flashcards Mode -->

    <!-- Test Area Mode -->
    <div x-show="showTestArea && !showTestSetList && !showTestSetBuilder" class="space-y-6">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <button @click="closeTestArea(); studyMaterialsFilter = 'all'" class="flex items-center space-x-2 px-4 py-2 bg-white/60 dark:bg-gray-700/60 hover:bg-white/80 dark:hover:bg-gray-600/80 backdrop-blur-sm rounded-lg transition-colors text-gray-700 dark:text-gray-300">
                    <svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span class="text-sm font-medium">Back to Flashcard Options</span>
                </button>
                <div class="flex items-center gap-2">
                    <div x-show="Object.values(testSets).length > 0" class="relative" x-data="{ open: false }" x-init="$nextTick(() => { if (window.lucide) lucide.createIcons(); }); $watch('open', value => { if (value && window.lucide) { lucide.createIcons(); } })" @keydown.escape.window="open = false">
                        <button @click="open = !open" class="p-2 bg-white/60 dark:bg-gray-700/60 backdrop-blur-sm rounded-md border border-gray-200 dark:border-gray-600 hover:bg-white/80 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300" :class="open ? 'ring-2 ring-purple-400/60' : ''" title="Sort test sets">
                            <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        </button>
                        <div x-cloak x-show="open" x-transition.origin-top-right class="absolute top-0 right-full mr-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg py-3 px-3 w-56" @click.outside="open = false" @click.stop>
                            <span class="block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">Sort test sets by</span>
                            <div class="space-y-2">
                                <button @click="testSetSort = 'updated'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="testSetSort === 'updated' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    <span>Date</span>
                                </button>
                                <button @click="testSetSort = 'cards'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="testSetSort === 'cards' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="layers" class="w-4 h-4"></i>
                                    <span>Cards</span>
                                </button>
                                <button @click="testSetSort = 'tries'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="testSetSort === 'tries' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="bar-chart" class="w-4 h-4"></i>
                                    <span>Tries</span>
                                </button>
                                <button @click="testSetSort = 'percentage'; open = false" class="w-full px-3 py-1.5 rounded-md border text-sm font-medium flex items-center gap-2 transition-colors" :class="testSetSort === 'percentage' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white dark:bg-gray-800 text-slate-600 dark:text-slate-200 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    <span>%</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button @click="openTestSetBuilder()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium flex items-center space-x-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Create Test Set</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Saved Test Sets List -->
        <div x-show="Object.values(testSets).length === 0" class="text-center py-16">
            <i data-lucide="clipboard-list" class="w-16 h-16 text-gray-400 dark:text-gray-600 mx-auto mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Test Sets Created</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-6">Create a custom test set by selecting cards from your decks</p>
            <button @click="openTestSetBuilder()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium inline-flex items-center space-x-2">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>Create Your First Test Set</span>
            </button>
        </div>
        <div x-show="Object.values(testSets).length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-init="$nextTick(() => { if (window.lucide) lucide.createIcons(); })">
            <template x-for="testSet in getSortedTestSets()" :key="testSet.id">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border-2 hover:shadow-lg transition-all" :class="testSet.pinned ? 'border-yellow-400 dark:border-yellow-600' : 'border-gray-200 dark:border-gray-700'" x-data="getTestSetStats(testSet)">
                    <div class="p-6">
                        <!-- Header with Actions -->
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 flex-1" x-text="testSet.name"></h3>
                            <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                <button @click="editTestSet(testSet.id)" class="p-1.5 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded transition-colors" title="Edit">
                                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button @click="togglePinTestSet(testSet.id)" class="p-1.5 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded transition-colors" :title="testSet.pinned ? 'Unpin' : 'Pin'">
                                    <i :data-lucide="testSet.pinned ? 'pin' : 'pin-off'" class="w-4 h-4 text-yellow-500 dark:text-yellow-400"></i>
                                </button>
                                <button @click="deleteTestSet(testSet.id)" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors" title="Delete">
                                    <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="flex items-center flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400 mb-3">
                            <span class="flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <span x-text="testSet.cards.length + ' cards'"></span>
                            </span>
                            <span x-show="hasResults" class="flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                <span x-text="tries + ' ' + (tries === 1 ? 'test' : 'tests')"></span>
                            </span>
                            <span x-show="hasResults" class="flex items-center space-x-1" :class="percentageClass">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span x-text="showPercentage ? (lastPercent + '%') : 'N/A'"></span>
                            </span>
                        </div>

                        <!-- Deck Names -->
                        <div class="mb-3">
                            <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Decks:</div>
                            <div class="flex flex-wrap gap-1.5">
                                <template x-for="deckName in [...new Set(testSet.cards.map(c => c.deckName))].slice(0, 3)" :key="deckName">
                                    <span class="inline-flex items-center px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded text-xs">
                                        <span x-text="deckName" class="truncate max-w-[120px]"></span>
                                    </span>
                                </template>
                                <span x-show="[...new Set(testSet.cards.map(c => c.deckName))].length > 3" class="inline-flex items-center px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded text-xs">
                                    +<span x-text="[...new Set(testSet.cards.map(c => c.deckName))].length - 3"></span> more
                                </span>
                            </div>
                        </div>

                        <!-- Date -->
                        <div class="text-xs text-gray-500 dark:text-gray-500 mb-4 border-t border-gray-200 dark:border-gray-700 pt-3">
                            Created: <span x-text="new Date(testSet.createdAt).toLocaleDateString()"></span>
                        </div>

                        <!-- Start Button -->
                        <button @click="startTestFromSet(testSet.id)" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium text-sm flex items-center justify-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <span>Start Test</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
    <!-- End Test Area Mode -->

    <!-- Test Set Builder -->
    <div x-show="showTestSetBuilder" class="space-y-6">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <button @click="closeTestSetBuilder()" class="flex items-center space-x-2 px-4 py-2 bg-white/60 dark:bg-gray-700/60 hover:bg-white/80 dark:hover:bg-gray-600/80 backdrop-blur-sm rounded-lg transition-colors text-gray-700 dark:text-gray-300">
                    <svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span class="text-sm font-medium">Back to Test Area</span>
                </button>
                <button @click="saveTestSet()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium flex items-center space-x-2">
                    <i data-lucide="save" class="w-5 h-5"></i>
                    <span>Save Test Set</span>
                </button>
            </div>
        </div>

        <!-- Test Set Name -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
            <label for="test-set-name" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Test Set Name</label>
            <input id="test-set-name" name="test-set-name" type="text" x-model="testSetBuilderName" placeholder="e.g., Mechanics Final Review" class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-slate-800 dark:text-slate-200 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left: Available Decks -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6 flex flex-col" style="height: 600px;">
                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">Available Decks</h3>

                <!-- Search -->
                <div class="mb-4 space-y-3 flex-shrink-0">
                    <input id="test-set-builder-search" name="test-set-builder-search" type="text" x-model="testSetBuilderSearch" placeholder="Search decks..." class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-slate-800 dark:text-slate-200 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    
                    <!-- Advanced Search: Filter by Tags -->
                    <div class="space-y-2">
                        <!-- Collapsible Header -->
                        <div class="flex items-center justify-between">
                            <button @click="showAdvancedSearch = !showAdvancedSearch; $nextTick(() => lucide.createIcons())" class="flex items-center gap-2 text-left">
                                <div class="text-sm font-semibold text-slate-700 dark:text-slate-300">Filter by Topic Tags</div>
                                <template x-if="advancedSearchTags.length > 0">
                                    <span class="px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-bold" x-text="advancedSearchTags.length"></span>
                                </template>
                                <i :data-lucide="showAdvancedSearch ? 'chevron-down' : 'chevron-right'" class="w-4 h-4 text-slate-600 dark:text-slate-400"></i>
                            </button>
                            <button @click="openTagSelector('advancedSearch'); $nextTick(() => lucide.createIcons())" class="flex items-center gap-1 px-2 py-1 text-xs border border-dashed border-blue-400 dark:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded transition-colors">
                                <i data-lucide="plus" class="w-3 h-3"></i>
                                <span>Add</span>
                            </button>
                        </div>
                        
                        <!-- Selected Tags Display (Collapsible) -->
                        <div x-show="showAdvancedSearch" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 -translate-y-2"
                             x-transition:enter-end="opacity-100 translate-y-0"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 translate-y-0"
                             x-transition:leave-end="opacity-0 -translate-y-2"
                             class="flex flex-wrap items-start gap-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 max-h-20 overflow-y-auto">
                            <template x-for="tagId in advancedSearchTags" :key="tagId">
                                <div class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs border border-blue-300 dark:border-blue-700 flex-shrink-0">
                                    <span class="font-mono font-bold" x-text="tagId"></span>
                                    <span x-text="topicLookup[tagId] ? topicLookup[tagId].topicTitle : ''"></span>
                                    <button @click="advancedSearchTags = advancedSearchTags.filter(t => t !== tagId); $nextTick(() => lucide.createIcons())" class="hover:bg-blue-200 dark:hover:bg-blue-800 rounded p-0.5 transition-colors">
                                        <i data-lucide="x" class="w-2.5 h-2.5"></i>
                                    </button>
                                </div>
                            </template>
                            
                            <div x-show="advancedSearchTags.length === 0" class="text-xs text-gray-500 dark:text-gray-400 italic">No tags selected</div>
                        </div>
                    </div>
                </div>

                <!-- Decks List -->
                <div class="space-y-3 flex-1 overflow-y-auto">
                    <template x-for="deck in filteredDecksForBuilder" :key="deck.id">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <!-- Deck Header -->
                            <div class="p-3 bg-gray-50 dark:bg-gray-700/50 flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <button @click="toggleDeckExpansion(deck.id)" class="hover:bg-gray-200 dark:hover:bg-gray-600 rounded p-1">
                                            <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 transition-transform duration-200" :class="testSetBuilderExpandedDecks[deck.id] ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </button>
                                        <h4 class="font-semibold text-slate-800 dark:text-slate-200 text-sm" x-text="deck.name"></h4>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 ml-7">
                                        <span x-text="deck.cards.length"></span> cards
                                        <template x-if="getDeckCardCount(deck.id) > 0">
                                            <span> â€¢ <span x-text="getDeckCardCount(deck.id)"></span> selected</span>
                                        </template>
                                    </p>
                                </div>
                                <button @click="addDeckToTestSet(deck.id)" :class="isDeckInTestSet(deck.id) ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'" :disabled="isDeckInTestSet(deck.id)" class="px-3 py-1 text-white rounded text-xs font-medium transition-colors">
                                    <span x-text="isDeckInTestSet(deck.id) ? 'Added' : 'Add All'"></span>
                                </button>
                            </div>

                            <!-- Cards List (Expanded) -->
                            <div x-show="testSetBuilderExpandedDecks[deck.id]" class="p-3 space-y-2 bg-white dark:bg-gray-800">
                                <template x-for="(card, index) in deck.cards" :key="window.generateCardKey(deck.id, card, index)">
                                    <div class="flex items-start space-x-2 p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <div class="flex-1 text-sm">
                                            <div class="text-slate-700 dark:text-slate-300 font-medium line-clamp-1" x-html="sanitizeHTML(card.front)"></div>
                                        </div>
                                        <button @click="addCardToTestSet(deck.id, card)" :class="isCardInTestSet(deck.id, card) ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'" :disabled="isCardInTestSet(deck.id, card)" class="px-2 py-1 text-white rounded text-xs font-medium transition-colors flex-shrink-0">
                                            <span x-text="isCardInTestSet(deck.id, card) ? 'âœ“' : '+'"></span>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <div x-show="filteredDecksForBuilder.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No decks found
                    </div>
                </div>
            </div>

            <!-- Right: Selected Cards -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6 flex flex-col" style="height: 600px;">
                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">
                    Selected Cards (<span x-text="testSetBuilderCards.length"></span>)
                </h3>

                <!-- Selected Cards List -->
                <div class="space-y-2 flex-1 overflow-y-auto">
                    <template x-for="(card, index) in testSetBuilderCards" :key="card.deckId ? window.generateCardKey(card.deckId, card, index) : (card.front + card.back).substring(0, 50) + index">
                        <div class="flex items-start space-x-2 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-800 dark:text-slate-200 line-clamp-2" x-html="sanitizeHTML(card.front)"></div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1" x-text="card.deckName"></div>
                            </div>
                            <button @click="removeCardFromTestSet(index)" class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors flex-shrink-0">
                                <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </template>

                    <div x-show="testSetBuilderCards.length === 0" class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <p>No cards selected yet</p>
                        <p class="text-sm mt-1">Add cards from the left panel</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inherited Tags Display -->
        <div x-show="testSetBuilderCards.length > 0" class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Inherited Tags from Selected Decks</h3>
            <div class="flex flex-wrap gap-2">
                <template x-for="tagId in inheritedTags" :key="tagId">
                    <span class="inline-flex items-center px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-sm">
                        <span class="font-mono font-bold mr-1.5" x-text="tagId"></span>
                        <span x-text="topicLookup[tagId] ? topicLookup[tagId].topicTitle : ''"></span>
                    </span>
                </template>
                <span x-show="inheritedTags.length === 0" class="text-sm text-gray-500 dark:text-gray-400 italic">
                    No tags inherited from selected decks
                </span>
            </div>
        </div>
    </div>
    <!-- End Test Set Builder -->
</div>
